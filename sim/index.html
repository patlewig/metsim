<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="patlewig" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Simulation (sim) - metsim</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Simulation (sim)";
        var mkdocs_page_input_path = "sim.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> metsim
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Simulation (sim)</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_bt">metsim_bt</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_bt.btrans_metsim_subprocess">btrans_metsim_subprocess</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_bt.recursive_gen_list">recursive_gen_list</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_cts">metsim_cts</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_cts.metsim_cts_query">metsim_cts_query</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_cts.metsim_run_cts">metsim_run_cts</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_tb">metsim_tb</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_tb.metsim_run_toolbox_api">metsim_run_toolbox_api</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_tb.metsim_search_toolbox_api">metsim_search_toolbox_api</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_tb.metsim_tb_search_logkow">metsim_tb_search_logkow</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_times">metsim_times</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#metsim.sim.metsim_times.metsim_run_times">metsim_run_times</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../utl/">Utilities</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">metsim</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Simulation (sim)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="simulation-sim">Simulation (sim)</h1>
<p>Sim contains APIs for the generation of metabolic simulation information from 4 main tools BioTransformer, the OECD Toolbox, EPA's Chemical Transformation Simulator (CTS) and TIssue Metabolism Simulator (TIMES).</p>


<div class="doc doc-object doc-module">



<a id="metsim.sim.metsim_bt"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="metsim.sim.metsim_bt.btrans_metsim_subprocess" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">btrans_metsim_subprocess</span><span class="p">(</span><span class="n">btrans_dir</span><span class="o">=</span><span class="s1">&#39;/home/jovyan/mybio&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ecbased&#39;</span><span class="p">,</span> <span class="s1">&#39;cyp450&#39;</span><span class="p">,</span> <span class="s1">&#39;phaseII&#39;</span><span class="p">],</span> <span class="n">cyp_mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">casrn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">del_tmp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtxsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chem_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multi_proc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Simulates human metabolism using BioTransformer via "subprocess" package virtual command line interface and Java command line inputs. Produces CSV output files in a ".\tmpfiles" folder 
Default settings are those from the 2024 MetSim manuscript (4 generations, 1 cycle Enzyme-Commission Based mixed Phase I &amp; Phase II/"ecbased" + 2 cycles Phase I/"cyp450" + 1 cycle of Phase II/"phaseII" models, respectively).</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>btrans_dir</code></b>
                  (<code>(str, required)</code>, default:
                      <code>&#39;/home/jovyan/mybio&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>file path leading to the BioTransformer3.0Jar directory. Default is C:\BioTransformer3.0Jar</p>
              </div>
            </li>
            <li>
              <b><code>models</code></b>
                  (<code>list of str</code>, default:
                      <code>[&#39;ecbased&#39;, &#39;cyp450&#39;, &#39;phaseII&#39;]</code>
)
              –
              <div class="doc-md-description">
                <p>List of models in the sequence they will be run. Default is ['ecbased','cyp450','phaseII']</p>
              </div>
            </li>
            <li>
              <b><code>cyp_mode</code></b>
                  (<code>int</code>, default:
                      <code>1</code>
)
              –
              <div class="doc-md-description">
                <p>"Cyp450" model execution mode. 1 uses CypReact as default engine (default), 2 uses CyProduct engine (prone to crashes as of June 2022), 3 is combined engine (CypReact+CyProduct engines)</p>
              </div>
            </li>
            <li>
              <b><code>smiles</code></b>
                  (<code>(str, required)</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>SMILES string corresponding to parent chemical. Default None</p>
              </div>
            </li>
            <li>
              <b><code>casrn</code></b>
                  (<code>str</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Chemical Abstracts Services Registry Number (CASRN), if known. Default None</p>
              </div>
            </li>
            <li>
              <b><code>del_tmp</code></b>
                  (<code>True / False</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Delete Tempfiles to free up storage after they are processed through recursive_gen_list. Default False</p>
              </div>
            </li>
            <li>
              <b><code>dtxsid</code></b>
                  (<code>str</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>EPA Distributed Structure Searchable Toxicity Database (DSSTox) Substance Identifier (DSTXSID) for parent chemical, if known. Default None </p>
              </div>
            </li>
            <li>
              <b><code>chem_name</code></b>
                  (<code>str</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Preferred chemical name of parent, if known. Default None</p>
              </div>
            </li>
            <li>
              <b><code>idx</code></b>
                  (<code>int</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Dummy index (default None). Only needed if feeding this function into a "multiprocess" function call to parallel process multiple parent chemicals with metsim_bt</p>
              </div>
            </li>
            <li>
              <b><code>multi_proc</code></b>
                  (<code>True / False</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>If using multiprocessing to ensure that "idx" parameter gets stored in output tuple. Default False</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>output</code></b>              –
              <div class="doc-md-description">
                <p>Tuple of Dummy index (for parallel processing), Dictionary of precursor and successor SMILES, CASRN, DTXSID, InChIKey as supplemented by HCD (or RDKit for InChIKey) and filename (if del_tmp = False).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>metsim/sim/metsim_bt.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">btrans_metsim_subprocess</span><span class="p">(</span><span class="n">btrans_dir</span> <span class="o">=</span> <span class="s1">&#39;/home/jovyan/mybio&#39;</span><span class="p">,</span>
                             <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ecbased&#39;</span><span class="p">,</span><span class="s1">&#39;cyp450&#39;</span><span class="p">,</span><span class="s1">&#39;phaseII&#39;</span><span class="p">],</span>
                             <span class="n">cyp_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="n">cycles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">smiles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">casrn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">del_tmp</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">dtxsid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">chem_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">multi_proc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Simulates human metabolism using BioTransformer via &quot;subprocess&quot; package virtual command line interface and Java command line inputs. Produces CSV output files in a &quot;.\\tmpfiles&quot; folder </span>
<span class="sd">    Default settings are those from the 2024 MetSim manuscript (4 generations, 1 cycle Enzyme-Commission Based mixed Phase I &amp; Phase II/&quot;ecbased&quot; + 2 cycles Phase I/&quot;cyp450&quot; + 1 cycle of Phase II/&quot;phaseII&quot; models, respectively).</span>

<span class="sd">    Args:</span>
<span class="sd">        btrans_dir (str, required): file path leading to the BioTransformer3.0Jar directory. Default is C:\BioTransformer3.0Jar</span>
<span class="sd">        models (list of str, optional): List of models in the sequence they will be run. Default is [&#39;ecbased&#39;,&#39;cyp450&#39;,&#39;phaseII&#39;]</span>
<span class="sd">        cyp_mode (int, optional): &quot;Cyp450&quot; model execution mode. 1 uses CypReact as default engine (default), 2 uses CyProduct engine (prone to crashes as of June 2022), 3 is combined engine (CypReact+CyProduct engines)</span>
<span class="sd">        cycles (list of int, optional) List of integer number of metabolism cycles each model will execute in the order they are defined in &quot;models&quot; parameter. Default is [1,2,1] to indicate 1 cycle of &quot;ecbased&quot;, 2 cycles of &quot;cyp450&quot;, and 1 cycle of &quot;phaseII&quot;</span>
<span class="sd">        smiles (str, required): SMILES string corresponding to parent chemical. Default None</span>
<span class="sd">        casrn (str, optional): Chemical Abstracts Services Registry Number (CASRN), if known. Default None</span>
<span class="sd">        del_tmp (True/False, optional): Delete Tempfiles to free up storage after they are processed through recursive_gen_list. Default False</span>
<span class="sd">        dtxsid (str, optional): EPA Distributed Structure Searchable Toxicity Database (DSSTox) Substance Identifier (DSTXSID) for parent chemical, if known. Default None </span>
<span class="sd">        chem_name (str, optional): Preferred chemical name of parent, if known. Default None</span>
<span class="sd">        idx (int, optional): Dummy index (default None). Only needed if feeding this function into a &quot;multiprocess&quot; function call to parallel process multiple parent chemicals with metsim_bt</span>
<span class="sd">        multi_proc (True/False, optional): If using multiprocessing to ensure that &quot;idx&quot; parameter gets stored in output tuple. Default False</span>

<span class="sd">    Returns: </span>
<span class="sd">         output: Tuple of Dummy index (for parallel processing), Dictionary of precursor and successor SMILES, CASRN, DTXSID, InChIKey as supplemented by HCD (or RDKit for InChIKey) and filename (if del_tmp = False).</span>

<span class="sd">    &#39;&#39;&#39;</span>

<span class="c1"># Need to determine how to implement recursion with multiprocessing...</span>

    <span class="c1">#set up initial dictionary outputs:</span>
    <span class="n">btrans_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%Hh%Mm%Ss&#39;</span><span class="p">)),</span>
                   <span class="s1">&#39;software&#39;</span><span class="p">:</span> <span class="s1">&#39;BioTransformer&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                   <span class="s1">&#39;params&#39;</span><span class="p">:{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">([</span><span class="n">cycles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;allHuman&#39;</span> <span class="o">!=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;superbio&#39;</span> <span class="o">!=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">else</span> <span class="mi">4</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">))]),</span>
                             <span class="s1">&#39;organism&#39;</span><span class="p">:</span> <span class="s1">&#39;Human&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;site_of_metabolism&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;x &#39;</span><span class="o">+</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))]</span>
                            <span class="p">}</span>
                  <span class="p">}</span>
    <span class="n">btrans_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">smiles</span><span class="p">,</span>
                            <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="n">casrn</span><span class="p">,</span>
                            <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="n">dtxsid</span><span class="p">,</span>
                            <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="n">chem_name</span>
                           <span class="p">}</span> 

    <span class="c1">#change directory to BioTransformer directory</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span> <span class="o">!=</span> <span class="n">btrans_dir</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">btrans_dir</span><span class="p">)</span>

   <span class="c1">#Ensure appropriate output CSV file folder exists for temporary files:</span>
    <span class="n">tmp_filepath</span> <span class="o">=</span><span class="s1">&#39;/home/jovyan/work/bt_tmpfiles&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp_filepath</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tmp_filepath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span> <span class="c1">#check that we have a SMILES string input</span>
        <span class="c1">#Begin constructing BioTransformer input command string:</span>
        <span class="n">btrans_cmd</span> <span class="o">=</span> <span class="s1">&#39;java -jar BioTransformer3.0.jar -k pred &#39;</span> <span class="c1">#current version</span>
        <span class="c1"># btrans_cmd = &#39;java -jar BioTransformer-1.1.5.jar -k pred &#39; #2019 paper version</span>
        <span class="c1"># btrans_cmd = &#39;java -jar BioTransformer-1-0-6.jar -k pred &#39; #original version (Only uses single models!)</span>
        <span class="c1">#incorporate model parameters into command string:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">btrans_model</span> <span class="o">=</span> <span class="s1">&#39;-b &quot;&#39;</span><span class="o">+</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&quot; &#39;</span>
            <span class="k">if</span> <span class="n">cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">btrans_model</span> <span class="o">=</span> <span class="n">btrans_model</span><span class="o">+</span><span class="s1">&#39;-s &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">btrans_model</span> <span class="o">=</span> <span class="s1">&#39;-q &quot;&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">btrans_model</span> <span class="o">=</span> <span class="n">btrans_model</span><span class="o">+</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">btrans_model</span> <span class="o">=</span> <span class="n">btrans_model</span><span class="o">+</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;&quot; &#39;</span>
        <span class="n">btrans_cmd</span> <span class="o">=</span> <span class="n">btrans_cmd</span><span class="o">+</span><span class="n">btrans_model</span><span class="o">+</span><span class="s1">&#39; -cm &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cyp_mode</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span> <span class="c1">#specify cyp_mode with later versions of BioTransformer</span>
        <span class="c1"># btrans_cmd = btrans_cmd+btrans_model+&#39; &#39; #no cyp_mode in input command for original 2019 relase of BioTransformer</span>
        <span class="c1">#create temporary file to store BioTransformer output:</span>
        <span class="k">if</span> <span class="n">dtxsid</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating output tempfile for index &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, DTXSID: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dtxsid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
            <span class="n">fnum</span><span class="p">,</span> <span class="n">fnam</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span> <span class="o">=</span> <span class="s1">&#39;/home/jovyan/work/bt_tmpfiles&#39;</span><span class="p">,</span>
                                          <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;btrans_out_&#39;</span><span class="o">+</span><span class="n">dtxsid</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">,</span>
                                          <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating output tempfile for index &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, InChIKey: &#39;</span><span class="o">+</span><span class="n">Chem</span><span class="o">.</span><span class="n">inchi</span><span class="o">.</span><span class="n">MolToInchiKey</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
                <span class="n">fnum</span><span class="p">,</span> <span class="n">fnam</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span> <span class="o">=</span> <span class="s1">&#39;/home/jovyan/work/bt_tmpfiles&#39;</span><span class="p">,</span>
                                              <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;btrans_out_&#39;</span><span class="o">+</span><span class="n">Chem</span><span class="o">.</span><span class="n">inchi</span><span class="o">.</span><span class="n">MolToInchiKey</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">,</span>
                                              <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating output tempfile for index &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, SMILES: &#39;</span><span class="o">+</span><span class="n">smiles</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
                <span class="n">fnum</span><span class="p">,</span> <span class="n">fnam</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span> <span class="o">=</span> <span class="s1">&#39;/home/jovyan/work/bt_tmpfiles&#39;</span><span class="p">,</span>
                                          <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;btrans_out_&#39;</span><span class="p">,</span>
                                          <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

        <span class="c1">#Finish constructing input command using the tempfile name:</span>
        <span class="n">fnam_split</span> <span class="o">=</span> <span class="n">fnam</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">btrans_fnam</span> <span class="o">=</span> <span class="n">tmp_filepath</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span><span class="n">fnam_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#insert input smiles string and output csv tempfile name:</span>
        <span class="n">btrans_cmd</span> <span class="o">=</span> <span class="n">btrans_cmd</span> <span class="o">+</span> <span class="s1">&#39;-ismi &quot;&#39;</span><span class="o">+</span><span class="n">smiles</span><span class="o">+</span><span class="s1">&#39;&quot; -ocsv &quot;&#39;</span><span class="o">+</span><span class="n">btrans_fnam</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span> <span class="c1">#use Daylight SMILES input</span>
        <span class="c1"># btrans_cmd = btrans_cmd + &#39;-isdf &quot;&#39;+smiles+&#39;&quot; -ocsv &quot;&#39;+btrans_fnam+&#39;&quot;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">btrans_cmd</span><span class="p">)</span>
        <span class="c1">#Run BioTransformer with subprocess and the appropriate input command string:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;beginning metsim for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
        <span class="n">btrans_out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">btrans_cmd</span><span class="p">,</span>
                                    <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span> 

        <span class="c1">#Preallocate data frame and read tempfile output if BioTransformer ran successfully:</span>
        <span class="n">btrans_out_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">btrans_out</span><span class="o">.</span><span class="n">stderr</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">btrans_out_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fnam</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error, check stdout&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">btrans_out</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

        <span class="n">btrans_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">multi_proc</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1">#Process metabolism data (if it exists for the given smiles):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">fnam</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">input_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fnam</span><span class="p">)</span>
                <span class="n">parent_list</span> <span class="o">=</span> <span class="n">input_df</span><span class="p">[</span><span class="s1">&#39;Precursor ID&#39;</span><span class="p">]</span>
                <span class="n">parent_list</span> <span class="o">=</span> <span class="n">parent_list</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
                <span class="n">btrans_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recursive_gen_list</span><span class="p">(</span><span class="n">input_df</span> <span class="o">=</span> <span class="n">input_df</span><span class="p">,</span>
                                                           <span class="n">parent_list</span> <span class="o">=</span> <span class="n">parent_list</span><span class="p">,</span>
                                                           <span class="n">successor_list</span> <span class="o">=</span> <span class="p">[],</span>
                                                           <span class="n">out_list</span> <span class="o">=</span> <span class="p">[],</span>
                                                           <span class="n">gen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#Valid SMILES given, no metabolites produced:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No metabolites produced for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">btrans_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="n">btrans_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                                          <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                          <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                          <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                         <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                         <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                         <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                         <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                         <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                                        <span class="p">}</span>
                                                        <span class="p">}]</span>
                                        <span class="p">}]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Need to determine how to multiprocess recursion, until then, store input parameters and output structure.</span>
            <span class="n">btrans_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="n">btrans_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span>
                                      <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                                      <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                      <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                      <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                     <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                     <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                     <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                     <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                     <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                                    <span class="p">}</span>
                                                    <span class="p">}]</span>
                                    <span class="p">}]</span>
        <span class="c1">#close temporary output file. Will delete if del_tempfile function input is set to True.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">del_tmp</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fnam</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No SMILES string provided for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="c1">#This list returns if no metabolites are formed/BioTransformer fails.</span>
        <span class="n">btrans_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                               <span class="p">},</span>
                                  <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                                  <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                  <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                  <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                 <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                 <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                 <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                 <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                 <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                                <span class="p">}</span>
                                                <span class="p">}]</span>
                                <span class="p">}]</span>
        <span class="n">btrans_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                               <span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MetSim complete for index &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">del_tmp</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1">#until figuring out how to implement recursive metabolite search with multiprocessing, return filename for separate analysis function.</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">btrans_dict</span><span class="p">,</span> <span class="n">fnam</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">btrans_dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>    
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="metsim.sim.metsim_bt.recursive_gen_list" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">recursive_gen_list</span><span class="p">(</span><span class="n">input_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">successor_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">gen</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Takes input dataframe derived from BioTransformer output CSV file for a given parent chemical, and recursively searches through the output Metabolite IDs 
and Precursor IDs in the dataframe to correlate precursor-metabolite relationships across metabolic generations. Outputs a list of generationally-tracked 
metabolites from the parent chemical and its precursors.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>input_df</code></b>
              –
              <div class="doc-md-description">
                <p>input dataframe (dataframe, required) derived from pandas read_csv of filename output from BioTransformer (btrans_metsim_subprocess output tuple, index 2 is CSV output filename)</p>
              </div>
            </li>
            <li>
              <b><code>successor_list</code></b>
              –
              <div class="doc-md-description">
                <p>Metabolite ID column values from the parent BioTransformer output CSV (list, optional)</p>
              </div>
            </li>
            <li>
              <b><code>parent_list</code></b>
              –
              <div class="doc-md-description">
                <p>Empty by default, previous generation's successor_list becomes the parent_list in later recursions until recursion is complete (i.e., empty successor_list) (list, optional)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>out_list</code></b>              –
              <div class="doc-md-description">
                <p>list of precursor-successor relationships for the parent chemical of interest in metsim hierarchical format.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>metsim/sim/metsim_bt.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">recursive_gen_list</span><span class="p">(</span><span class="n">input_df</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">parent_list</span> <span class="o">=</span> <span class="p">[],</span>
                       <span class="n">successor_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">out_list</span> <span class="o">=</span> <span class="p">[],</span>
                       <span class="n">gen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes input dataframe derived from BioTransformer output CSV file for a given parent chemical, and recursively searches through the output Metabolite IDs </span>
<span class="sd">    and Precursor IDs in the dataframe to correlate precursor-metabolite relationships across metabolic generations. Outputs a list of generationally-tracked </span>
<span class="sd">    metabolites from the parent chemical and its precursors.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_df: input dataframe (dataframe, required) derived from pandas read_csv of filename output from BioTransformer (btrans_metsim_subprocess output tuple, index 2 is CSV output filename)</span>
<span class="sd">        successor_list: Metabolite ID column values from the parent BioTransformer output CSV (list, optional)</span>
<span class="sd">        parent_list: Empty by default, previous generation&#39;s successor_list becomes the parent_list in later recursions until recursion is complete (i.e., empty successor_list) (list, optional)</span>

<span class="sd">    Returns:</span>
<span class="sd">        out_list: list of precursor-successor relationships for the parent chemical of interest in metsim hierarchical format.</span>

<span class="sd">    &quot;&quot;&quot;</span>



    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_df</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">:</span>
        <span class="k">raise</span><span class="p">(</span><span class="s1">&#39;Please include BioTransformer output csv dataframe as input_df.&#39;</span><span class="p">)</span>
    <span class="n">successor_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">parent_list</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">parent_list</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">successor_df</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">input_df</span><span class="p">[</span><span class="s1">&#39;Precursor ID&#39;</span><span class="p">]),:]</span>
            <span class="n">successor_list</span> <span class="o">=</span> <span class="n">successor_df</span><span class="p">[</span><span class="s1">&#39;Metabolite ID&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">successor_list</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Successors found for parent chemical&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">successor_df</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">input_df</span><span class="p">[</span><span class="s1">&#39;Precursor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">parent_list</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span>
            <span class="n">successor_list</span> <span class="o">=</span> <span class="n">successor_df</span><span class="p">[</span><span class="s1">&#39;Metabolite ID&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">successor_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">successor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">successor_df</span><span class="p">[</span><span class="s1">&#39;Precursor SMILES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                       <span class="p">},</span>
                          <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="n">successor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="s1">&#39;Enzyme(s)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span>
                                          <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="n">successor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="s1">&#39;Reaction&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="n">gen</span><span class="p">,</span>
                                          <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">successor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="s1">&#39;SMILES&#39;</span><span class="p">],</span>
                                                         <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                         <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                         <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                         <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                         <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                        <span class="p">}</span>
                                       <span class="p">}</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">successor_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                             <span class="p">}</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">parent_list</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">successor_df</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; successors found for gen &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; precursor &#39;</span><span class="o">+</span><span class="n">parent_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">successor_dict</span><span class="p">[</span><span class="s1">&#39;precursor&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">out_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;precursor&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_list</span><span class="p">))]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precursor-successor relationship already recorded, skipping to next precursor.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_list</span> <span class="o">=</span> <span class="n">out_list</span><span class="o">+</span><span class="p">[</span><span class="n">successor_dict</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dict added to out_list for index &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="c1">#check for more generations:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">successor_list</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting recursion on successor index &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="n">out_list</span> <span class="o">=</span> <span class="n">recursive_gen_list</span><span class="p">(</span><span class="n">input_df</span> <span class="o">=</span> <span class="n">input_df</span><span class="p">,</span>
                                                  <span class="n">parent_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">successor_list</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span>
                                                  <span class="n">successor_list</span> <span class="o">=</span> <span class="p">[],</span>
                                                  <span class="n">out_list</span> <span class="o">=</span> <span class="n">out_list</span><span class="p">,</span>
                                                  <span class="n">gen</span> <span class="o">=</span> <span class="n">gen</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;recursion complete for successor index &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">out_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No successors for gen &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; precursor &#39;</span><span class="o">+</span><span class="n">parent_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;, moving to next gen 1 precursor.&#39;</span><span class="p">)</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">out_list</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="metsim.sim.metsim_cts"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="metsim.sim.metsim_cts.metsim_cts_query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">metsim_cts_query</span><span class="p">(</span><span class="n">smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gens</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Helper function to query the REST API for EPA CTS ChemAxon Human Phase I metabolic simulator.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>smiles</code></b>
                  (<code>(str, required)</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>parent/precursor SMILES string that will serve as the value for the "structure" key in the POST JSON for the API request.</p>
              </div>
            </li>
            <li>
              <b><code>gens</code></b>
                  (<code>(int, required)</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>An integer value for number of metabolism cycles/generations (0-4)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>metsim/sim/metsim_cts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">metsim_cts_query</span><span class="p">(</span><span class="n">smiles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to query the REST API for EPA CTS ChemAxon Human Phase I metabolic simulator.</span>

<span class="sd">    Args:</span>
<span class="sd">        smiles (str, required): parent/precursor SMILES string that will serve as the value for the &quot;structure&quot; key in the POST JSON for the API request.</span>
<span class="sd">        gens (int, required): An integer value for number of metabolism cycles/generations (0-4)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">smiles</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gens</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">gens</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://qed.epa.gov/cts/rest/metabolizer/run&#39;</span>
            <span class="n">post</span> <span class="o">=</span>  <span class="p">{</span><span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="n">smiles</span><span class="p">,</span> <span class="s2">&quot;generationLimit&quot;</span><span class="p">:</span> <span class="n">gens</span><span class="p">,</span> <span class="s2">&quot;transformationLibraries&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mammalian_metabolism&quot;</span><span class="p">]}</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>    
                <span class="n">output</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">,</span> <span class="n">json</span> <span class="o">=</span> <span class="n">post</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CTS API successfully returned metabolism predictions for &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; cycles of Phase I metabolism for input SMILES: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">smiles</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">output</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CTS API failed to generate metabolites.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generations must be between 1 and 4.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="metsim.sim.metsim_cts.metsim_run_cts" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">metsim_run_cts</span><span class="p">(</span><span class="n">in_smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cts_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Run CTS Human Phase I metabolism simulator for input SMILES and transformation depth, then recursively process the CTS output into metsim hierarchy structure.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>smiles</code></b>
                  (<code>(str, required)</code>)
              –
              <div class="doc-md-description">
                <p>input SMILES string. Default None</p>
              </div>
            </li>
            <li>
              <b><code>depth</code></b>
                  (<code>(int, required)</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Transformation depth in terms of integer number of metabolism cycles/generations (1-4). Default 3</p>
              </div>
            </li>
            <li>
              <b><code>cts_data</code></b>
                  (<code>dict</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>CTS output JSON dictionary, used for recursion</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>out_dict</code></b>              –
              <div class="doc-md-description">
                <p>MetSim hierarchically structured output dictionary</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>metsim/sim/metsim_cts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">metsim_run_cts</span><span class="p">(</span><span class="n">in_smiles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cts_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run CTS Human Phase I metabolism simulator for input SMILES and transformation depth, then recursively process the CTS output into metsim hierarchy structure.</span>

<span class="sd">    Args:</span>
<span class="sd">        smiles (str, required): input SMILES string. Default None</span>
<span class="sd">        depth (int, required): Transformation depth in terms of integer number of metabolism cycles/generations (1-4). Default 3</span>
<span class="sd">        cts_data (dict, optional): CTS output JSON dictionary, used for recursion</span>

<span class="sd">    Returns:</span>
<span class="sd">        out_dict: MetSim hierarchically structured output dictionary</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#generate initial output dictionary hierarchy, and obtain CTS JSON output from API:</span>
    <span class="k">if</span> <span class="n">out_dict</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%Hh%Mm%Ss&#39;</span><span class="p">)),</span>
                     <span class="s1">&#39;software&#39;</span><span class="p">:</span> <span class="s1">&#39;EPA Chemical Transformation Simulator&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.3.2.2&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;params&#39;</span><span class="p">:{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">,</span>
                               <span class="s1">&#39;organism&#39;</span><span class="p">:</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;site_of_metabolism&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;ChemAxon Human Phase I&#39;</span>
                              <span class="p">},</span>
                     <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">in_smiles</span><span class="p">,</span>
                               <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                              <span class="p">},</span>
                     <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">[]</span>
                   <span class="p">}</span>

    <span class="c1">#if no CTS output data exists, query the API</span>
    <span class="k">if</span> <span class="n">cts_data</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>            
        <span class="n">cts_data</span> <span class="o">=</span> <span class="n">metsim_cts_query</span><span class="p">(</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">in_smiles</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1">#if the API call fails and yields no output</span>
        <span class="k">if</span> <span class="n">cts_data</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cts_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CTS API call yielded no output data.&#39;</span><span class="p">)</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;api_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">successor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;likelihood&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                           <span class="p">},</span>
                               <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;likelihood&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                             <span class="p">}</span>
                                              <span class="p">}]</span>
                             <span class="p">}</span>

            <span class="c1">#At least supplement metadata with inchikey from RDKit if possible</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;inchikey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">inchi</span><span class="o">.</span><span class="n">MolToInchiKey</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RDKit InChIKey generation for input SMILES: &#39;</span><span class="o">+</span><span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; succeeded.&#39;</span><span class="p">)</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">successor_dict</span><span class="p">)</span> 
                <span class="k">return</span> <span class="n">out_dict</span> 
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RDKit InChIKey generation failed.&#39;</span><span class="p">)</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">successor_dict</span><span class="p">)</span> 
                <span class="k">return</span> <span class="n">out_dict</span>

    <span class="c1">#successful API call will have a key in the output dictionary for &quot;children&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;children&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cts_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;children key found in dictionary&#39;</span><span class="p">)</span>
        <span class="c1">#if metabolites are present in this level, store their information</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]))</span><span class="o">+</span><span class="s1">&#39; children found for precursor generation level &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;generation&#39;</span><span class="p">]))</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;api_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">successor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;likelihood&#39;</span><span class="p">:</span> <span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;likelihood&#39;</span><span class="p">]</span>
                                           <span class="p">},</span>
                               <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;routes&#39;</span><span class="p">],</span>
                                               <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;generation&#39;</span><span class="p">],</span>
                                               <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">],</span>
                                                              <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;likelihood&#39;</span><span class="p">:</span> <span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;likelihood&#39;</span><span class="p">]</span>
                                                             <span class="p">}</span>
                                              <span class="p">}</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]))]</span>
                             <span class="p">}</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">successor_dict</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;precursor-successor relationships appended for current generational level.&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">])):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;children&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;children found in next generational level, recursing...&#39;</span><span class="p">)</span>
                    <span class="n">out_dict</span> <span class="o">=</span> <span class="n">metsim_run_cts</span><span class="p">(</span><span class="n">in_smiles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cts_data</span> <span class="o">=</span> <span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">,</span> <span class="n">out_dict</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#no children returned, but successful API call:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CTS API call successful. No metabolites produced for SMILES: &#39;</span><span class="o">+</span><span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">])</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;api_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">successor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="s1">&#39;likelihood&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                           <span class="p">},</span>
                               <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                              <span class="s1">&#39;likelihood&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                             <span class="p">}</span>
                                              <span class="p">}]</span>
                             <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;precursor&#39;</span><span class="p">][</span><span class="s1">&#39;inchikey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">inchi</span><span class="o">.</span><span class="n">MolToInchiKey</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RDKit InChIKey generation for input SMILES: &#39;</span><span class="o">+</span><span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; succeeded.&#39;</span><span class="p">)</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">successor_dict</span><span class="p">)</span> 
                <span class="k">return</span> <span class="n">out_dict</span> 
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RDKit InChIKey generation failed.&#39;</span><span class="p">)</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">successor_dict</span><span class="p">)</span> 
                <span class="k">return</span> <span class="n">out_dict</span> 
            <span class="k">return</span> <span class="n">out_dict</span>
    <span class="k">elif</span> <span class="s1">&#39;children&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cts_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">cts_data</span> <span class="o">=</span> <span class="n">cts_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">metsim_run_cts</span><span class="p">(</span><span class="n">in_smiles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cts_data</span> <span class="o">=</span> <span class="n">cts_data</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">,</span> <span class="n">out_dict</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="metsim.sim.metsim_tb"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="metsim.sim.metsim_tb.metsim_run_toolbox_api" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">metsim_run_toolbox_api</span><span class="p">(</span><span class="n">host_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tb_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simulator_num</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">casrn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtxsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chem_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Runs a metabolism simulator of choice via an existing running instance of the OECD QSAR Toolbox Server Web API. 
Returns the hierarchically structured MetSim dictionary output of predicted metabolites.</p>
<p>Args:
host_name (str, required): "localhost" if running a local instance of the toolbox server.
tb_port (int, required): integer corresponding to the port number that was set when the toolbox server was started up (e.g., 9999).
simulator_num (int, required): integer between 0-16 corresponding to the index of the simulator GUID list that dictates which metabolism simulator to use.
                               use 8 for In Vivo Rat Simulator or 15 for In Vitro Rat Liver S9. All other models are given in the Swagger UI for the API at 
                               http://localhost:tb_port/Swagger
smiles (str, required) : SMILES for the parent chemical of interest
casrn (str, optional): Chemical Abstract Services Registry Number (CASRN) for the parent chemical of interest
dtxsid (str, optional): Distributed Structure Searchable Toxicity (DSSTox) Database Identifier (DTXSID) for the parent chemical of interest
chem_name (str, optional): Preferred chemical name for the parent chemical of interest
idx (int, optional) : Dummy index for use with "multiprocess" when parallel processing this function.</p>
<p>Returns:
: tuple of (idx, oecd_dict), where oecd_dict is a dictionary of hierarchically structured, metsim predicted precursor-successor relationships for the parent input chemical</p>

            <details class="quote">
              <summary>Source code in <code>metsim/sim/metsim_tb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">metsim_run_toolbox_api</span><span class="p">(</span><span class="n">host_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tb_port</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">simulator_num</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
                       <span class="n">smiles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">casrn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">dtxsid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">chem_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Runs a metabolism simulator of choice via an existing running instance of the OECD QSAR Toolbox Server Web API. </span>
<span class="sd">	Returns the hierarchically structured MetSim dictionary output of predicted metabolites.</span>

<span class="sd">	Args:</span>
<span class="sd">        host_name (str, required): &quot;localhost&quot; if running a local instance of the toolbox server.</span>
<span class="sd">        tb_port (int, required): integer corresponding to the port number that was set when the toolbox server was started up (e.g., 9999).</span>
<span class="sd">        simulator_num (int, required): integer between 0-16 corresponding to the index of the simulator GUID list that dictates which metabolism simulator to use.</span>
<span class="sd">                                       use 8 for In Vivo Rat Simulator or 15 for In Vitro Rat Liver S9. All other models are given in the Swagger UI for the API at </span>
<span class="sd">                                       http://localhost:tb_port/Swagger</span>
<span class="sd">        smiles (str, required) : SMILES for the parent chemical of interest</span>
<span class="sd">        casrn (str, optional): Chemical Abstract Services Registry Number (CASRN) for the parent chemical of interest</span>
<span class="sd">        dtxsid (str, optional): Distributed Structure Searchable Toxicity (DSSTox) Database Identifier (DTXSID) for the parent chemical of interest</span>
<span class="sd">        chem_name (str, optional): Preferred chemical name for the parent chemical of interest</span>
<span class="sd">        idx (int, optional) : Dummy index for use with &quot;multiprocess&quot; when parallel processing this function.</span>

<span class="sd">	Returns:</span>
<span class="sd">        : tuple of (idx, oecd_dict), where oecd_dict is a dictionary of hierarchically structured, metsim predicted precursor-successor relationships for the parent input chemical </span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1">#simulator num is 15 for in vitro and 8 for in vivo</span>
	<span class="n">metsim_url_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;http://</span><span class="si">{</span><span class="n">host_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tb_port</span><span class="si">}</span><span class="s2">/api/v6/Metabolism/&quot;&quot;&quot;</span>
	<span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">metsim_url_base</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">oecd_metsim_guids</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
	<span class="c1">#store GUID of metabolism simulator</span>
	<span class="n">guid</span> <span class="o">=</span> <span class="n">oecd_metsim_guids</span><span class="p">[</span><span class="n">simulator_num</span><span class="p">][</span><span class="s1">&#39;Guid&#39;</span><span class="p">]</span>
	<span class="c1">#Store base metsim info in output dictionary:</span>
	<span class="n">oecd_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%Hh%Mm%Ss&#39;</span><span class="p">)),</span>
		         <span class="s1">&#39;software&#39;</span><span class="p">:</span> <span class="s1">&#39;OECD QSAR Toolbox WebAPI&#39;</span><span class="p">,</span>
		         <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
		         <span class="s1">&#39;params&#39;</span><span class="p">:{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
		                   <span class="s1">&#39;organism&#39;</span><span class="p">:</span> <span class="s1">&#39;Rat&#39;</span><span class="p">,</span>
		                   <span class="s1">&#39;site_of_metabolism&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
		                   <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">oecd_metsim_guids</span><span class="p">[</span><span class="n">simulator_num</span><span class="p">][</span><span class="s1">&#39;Caption&#39;</span><span class="p">]]</span>
		                  <span class="p">}</span>
		        <span class="p">}</span>

	<span class="c1">#make lambda function to perform metsim in API:</span>
	<span class="n">metsim_exec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">url</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
	<span class="c1">#Lambda function to search with url-encoded SMILES:</span>
	<span class="n">search_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;http://</span><span class="si">{</span><span class="n">host_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tb_port</span><span class="si">}</span><span class="s2">/api/v6/Search/&quot;&quot;&quot;</span>
	<span class="n">search_smiles</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">smiles</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">search_base</span><span class="o">+</span><span class="s1">&#39;smiles/false/true?smiles=&#39;</span><span class="o">+</span><span class="n">smiles</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
	<span class="c1">#Lambda function to search on casrn if qsar_ready_smiles = nan:</span>
	<span class="n">search_cas</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">casrn</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">search_base</span><span class="o">+</span><span class="s1">&#39;cas/&#39;</span><span class="o">+</span><span class="n">casrn</span><span class="o">+</span><span class="s1">&#39;/true&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
	<span class="n">stereo_filter</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;@&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">]</span>
	<span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">smiles</span><span class="p">,</span>
		                  <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                  <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="n">casrn</span><span class="p">,</span>
		                  <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                  <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="n">dtxsid</span><span class="p">,</span>
		                  <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="n">chem_name</span>
		                 <span class="p">}</span>
	<span class="n">oecd_metab_list</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
		<span class="c1">#url encode SMILES</span>
		<span class="n">smiles_encoded</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
		<span class="c1">#Try metsim with base SMILES call first before doing anything more complicated than that:</span>
		<span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">smiles_encoded</span><span class="p">):</span>
		    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attempting metsim from SMILES input for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
		    <span class="n">metsim_url</span> <span class="o">=</span> <span class="n">metsim_url_base</span><span class="o">+</span><span class="n">guid</span><span class="o">+</span><span class="s1">&#39;?smiles=&#39;</span><span class="o">+</span><span class="n">smiles_encoded</span>  
		    <span class="n">oecd_metab_list</span> <span class="o">=</span> <span class="n">metsim_exec</span><span class="p">(</span><span class="n">metsim_url</span><span class="p">)</span> <span class="c1">#store metabolite list for the input precursor</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oecd_metab_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
		    <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		    <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span>
		                                <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">oecd_metab_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
		                                                               <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                               <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                               <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                               <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                               <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
		                                                              <span class="p">},</span>
		                                               <span class="p">}</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oecd_metab_list</span><span class="p">))]</span>
		                              <span class="p">})</span>
		    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;metsim succeeded for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
		    <span class="n">oecd_dict</span> <span class="o">=</span> <span class="n">idx</span>
	<span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">casrn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;NOCAS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">casrn</span><span class="p">):</span>
		<span class="n">oecd_dict</span> <span class="o">=</span> <span class="n">idx</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="c1">#This dictionary returns if no SMILES or CASRN are given:</span>
		<span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                      <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                      <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                      <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                      <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                      <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
		                     <span class="p">}</span>
		<span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                      <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                      <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                      <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                      <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                      <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
		                                     <span class="p">},</span>
		                        <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="p">[],</span>
		                                        <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                        <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                       <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                       <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                       <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                       <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
		                                                       <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
		                                                       <span class="p">}</span>
		                                      <span class="p">}]</span>
		                      <span class="p">}]</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;metsim failed for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;. Neither SMILES nor CASRN were provided.&#39;</span><span class="p">)</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">oecd_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="metsim.sim.metsim_tb.metsim_search_toolbox_api" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">metsim_search_toolbox_api</span><span class="p">(</span><span class="n">tb_port</span><span class="o">=</span><span class="mi">16384</span><span class="p">,</span> <span class="n">host_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simulator_num</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">casrn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtxsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chem_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Version of metsim_run_toolbox_api that does not perform the SMILES metsim query, but searches for alternate Toolbox database ChemIds using CASRN, 
and the resulting SMILES for any obtained ChemIDs to perform simulation via the same procedure as metsim_run_toolbox_api.</p>
<p>Run serially to circumvent toolbox search server crash issues until rectified by LMC service pack updates.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>host_name</code></b>
                  (<code>(str, required)</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>"localhost" if running a local instance of the toolbox server.</p>
              </div>
            </li>
            <li>
              <b><code>tb_port</code></b>
                  (<code>(int, required)</code>, default:
                      <code>16384</code>
)
              –
              <div class="doc-md-description">
                <p>integer corresponding to the port number that was set when the toolbox server was started up (e.g., 9999).</p>
              </div>
            </li>
            <li>
              <b><code>simulator_num</code></b>
                  (<code>(int, required)</code>, default:
                      <code>15</code>
)
              –
              <div class="doc-md-description">
                <p>integer between 0-16 corresponding to the index of the simulator GUID list that dictates which metabolism simulator to use.
                           use 8 for In Vivo Rat Simulator or 15 for In Vitro Rat Liver S9. All other models are given in the Swagger UI for the API at 
                           http://localhost:tb_port/Swagger</p>
              </div>
            </li>
            <li>
              <b><code>smiles</code></b>
                  (<code>(str, required)</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>SMILES for the parent chemical of interest</p>
              </div>
            </li>
            <li>
              <b><code>casrn</code></b>
                  (<code>str</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Chemical Abstract Services Registry Number (CASRN) for the parent chemical of interest</p>
              </div>
            </li>
            <li>
              <b><code>dtxsid</code></b>
                  (<code>str</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Distributed Structure Searchable Toxicity (DSSTox) Database Identifier (DTXSID) for the parent chemical of interest</p>
              </div>
            </li>
            <li>
              <b><code>chem_name</code></b>
                  (<code>str</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Preferred chemical name for the parent chemical of interest</p>
              </div>
            </li>
            <li>
              <b><code>idx</code></b>
                  (<code>int</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Dummy index for use with "multiprocess" when parallel processing this function.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>tuple of (idx, oecd_dict), where oecd_dict is a dictionary of hierarchically structured, metsim predicted precursor-successor relationships for the parent input chemical</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>metsim/sim/metsim_tb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">metsim_search_toolbox_api</span><span class="p">(</span><span class="n">tb_port</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">,</span>
                              <span class="n">host_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">simulator_num</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
                              <span class="n">smiles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">casrn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">dtxsid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">chem_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Version of metsim_run_toolbox_api that does not perform the SMILES metsim query, but searches for alternate Toolbox database ChemIds using CASRN, </span>
<span class="sd">    and the resulting SMILES for any obtained ChemIDs to perform simulation via the same procedure as metsim_run_toolbox_api.</span>

<span class="sd">    Run serially to circumvent toolbox search server crash issues until rectified by LMC service pack updates.</span>

<span class="sd">    Args:</span>
<span class="sd">        host_name (str, required): &quot;localhost&quot; if running a local instance of the toolbox server.</span>
<span class="sd">        tb_port (int, required): integer corresponding to the port number that was set when the toolbox server was started up (e.g., 9999).</span>
<span class="sd">        simulator_num (int, required): integer between 0-16 corresponding to the index of the simulator GUID list that dictates which metabolism simulator to use.</span>
<span class="sd">                                       use 8 for In Vivo Rat Simulator or 15 for In Vitro Rat Liver S9. All other models are given in the Swagger UI for the API at </span>
<span class="sd">                                       http://localhost:tb_port/Swagger</span>
<span class="sd">        smiles (str, required): SMILES for the parent chemical of interest</span>
<span class="sd">        casrn (str, optional): Chemical Abstract Services Registry Number (CASRN) for the parent chemical of interest</span>
<span class="sd">        dtxsid (str, optional): Distributed Structure Searchable Toxicity (DSSTox) Database Identifier (DTXSID) for the parent chemical of interest</span>
<span class="sd">        chem_name (str, optional): Preferred chemical name for the parent chemical of interest</span>
<span class="sd">        idx (int, optional): Dummy index for use with &quot;multiprocess&quot; when parallel processing this function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple of (idx, oecd_dict), where oecd_dict is a dictionary of hierarchically structured, metsim predicted precursor-successor relationships for the parent input chemical </span>

<span class="sd">    &quot;&quot;&quot;</span>




    <span class="c1">#Version of toolbox_metsim_api that does not do the SMILES metsim query, but searches for ChemIds on SMILES and CASRN to do metsim.</span>
    <span class="c1">#Run serially to circumvent TB search server crash issues until rectified by LMC updates.</span>


    <span class="n">metsim_url_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;http://</span><span class="si">{</span><span class="n">host_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tb_port</span><span class="si">}</span><span class="s2">/api/v6/Metabolism/&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">metsim_url_base</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">oecd_metsim_guids</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="c1">#store GUID of metabolism simulator</span>
    <span class="n">guid</span> <span class="o">=</span> <span class="n">oecd_metsim_guids</span><span class="p">[</span><span class="n">simulator_num</span><span class="p">][</span><span class="s1">&#39;Guid&#39;</span><span class="p">]</span>
    <span class="c1">#Store base metsim info in output dictionary:</span>
    <span class="n">oecd_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%Hh%Mm%Ss&#39;</span><span class="p">)),</span>
                 <span class="s1">&#39;software&#39;</span><span class="p">:</span> <span class="s1">&#39;OECD QSAR Toolbox WebAPI&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                 <span class="s1">&#39;params&#39;</span><span class="p">:{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                           <span class="s1">&#39;organism&#39;</span><span class="p">:</span> <span class="s1">&#39;Rat&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;site_of_metabolism&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">oecd_metsim_guids</span><span class="p">[</span><span class="n">simulator_num</span><span class="p">][</span><span class="s1">&#39;Caption&#39;</span><span class="p">]]</span>
                          <span class="p">}</span>
                <span class="p">}</span>

    <span class="c1">#make lambda function to perform metsim in API:</span>
    <span class="n">metsim_exec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">url</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="c1">#Lambda function to search with url-encoded SMILES:</span>
    <span class="n">search_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;http://</span><span class="si">{</span><span class="n">host_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tb_port</span><span class="si">}</span><span class="s2">/api/v6/search/&quot;&quot;&quot;</span>
    <span class="n">search_smiles</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">smiles</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">search_base</span><span class="o">+</span><span class="s1">&#39;smiles/false/true?smiles=&#39;</span><span class="o">+</span><span class="n">smiles</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="c1">#Lambda function to search on casrn if qsar_ready_smiles = nan:</span>
    <span class="n">search_cas</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">casrn</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">search_base</span><span class="o">+</span><span class="s1">&#39;cas/&#39;</span><span class="o">+</span><span class="n">casrn</span><span class="o">+</span><span class="s1">&#39;/true&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">stereo_filter</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;@&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">]</span> <span class="c1">#comment if using daylight smiles with stereochemistry, uncomment for qsar-ready smiles</span>
    <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">smiles</span><span class="p">,</span>
                          <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="n">casrn</span><span class="p">,</span>
                          <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="n">dtxsid</span><span class="p">,</span>
                          <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="n">chem_name</span>
                         <span class="p">}</span>
    <span class="n">oecd_metab_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">smiles_encoded</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
        <span class="c1">#url encode SMILES</span>
        <span class="n">smiles_encoded</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">casrn</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Base SMILES query for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; yields no metabolites. Searching for alternate ChemIds...&#39;</span><span class="p">)</span>
        <span class="c1">#casrn without hyphens:</span>
        <span class="k">if</span> <span class="s1">&#39;NOCAS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">casrn</span><span class="p">:</span>
            <span class="n">cas_nohyphen</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">casrn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
        <span class="n">chem_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#Query database on both smiles and casrn within try statements.</span>
        <span class="c1">#Necessary becasue of HTTP Errors for some chemicals:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">smiles_encoded</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">chem_entries</span> <span class="o">=</span> <span class="n">search_smiles</span><span class="p">(</span><span class="n">smiles_encoded</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad http request for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; SMILES&#39;</span><span class="p">)</span>
                <span class="n">chem_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;NOCAS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">casrn</span><span class="p">:</span>
                    <span class="n">chem_cas</span> <span class="o">=</span> <span class="n">search_cas</span><span class="p">(</span><span class="n">cas_nohyphen</span><span class="p">)</span>
                    <span class="n">chem_entries</span> <span class="o">=</span> <span class="n">chem_entries</span><span class="o">+</span><span class="n">chem_cas</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad http request for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; CASRN&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;NOCAS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">casrn</span><span class="p">:</span>
                    <span class="n">chem_entries</span> <span class="o">=</span> <span class="n">search_cas</span><span class="p">(</span><span class="n">cas_nohyphen</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad http request for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; CASRN&#39;</span><span class="p">)</span>
                <span class="n">chem_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#remove chem name lists from dicts so that duplicate dicts can be removed via set comprehension</span>
            <span class="n">rem_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">chem_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Names&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">))]</span>
            <span class="n">chem_entries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">))}]</span> <span class="c1">#remove duplicate entries</span>
            <span class="c1">#Filter out mixtures, and substances with no casrn:</span>
            <span class="n">chem_mono</span> <span class="o">=</span> <span class="p">[</span><span class="n">chem_entries</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">chem_entries</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;SubstanceType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MonoConstituent&#39;</span> <span class="ow">and</span> <span class="n">chem_entries</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;Cas&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="c1">#Store ChemID so long as smiles has no stereo information:</span>
            <span class="n">chem_Id</span> <span class="o">=</span> <span class="p">[</span><span class="n">chem_mono</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;ChemId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_mono</span><span class="p">))</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">stereo_filter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">chem_mono</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;Smiles&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stereo_filter</span><span class="p">))])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="c1">#uncomment if using qsar-ready smiles</span>
            <span class="c1"># chem_Id = [chem_mono[j][&#39;ChemId&#39;] for j in range(len(chem_mono))] #uncomment if using daylight smiles with stereochemistry</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chem_Id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternate ChemId corresponding to a QSAR-Ready SMILES found for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;. Attempting metsim...&#39;</span><span class="p">)</span>
                <span class="c1">#Cosntruct URL from base call for metsims + GUID of the simulator + ChemID:</span>
                <span class="c1">#In most cases, anything filtered down this far likely has the same SMILES </span>
                <span class="c1">#even if ChemID is different, will yield same metabolite list.</span>
                <span class="c1">#So just take the first one.</span>
                <span class="n">metsim_url</span> <span class="o">=</span> <span class="n">metsim_url_base</span><span class="o">+</span><span class="n">guid</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">chem_Id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">oecd_metab_list</span> <span class="o">=</span> <span class="n">metsim_exec</span><span class="p">(</span><span class="n">metsim_url</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">chem_mono</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Metsim failed. Alternate monoconstituent ChemIds found. Attempting metsim for alternate ChemId 1/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_mono</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
                <span class="c1">#If the only monoconstituent db entries have a stereo SMILES associated with our search, </span>
                <span class="c1">#just run it using that ChemId, will likely yield metabolites over an empty list.</span>
                <span class="n">chem_Id</span> <span class="o">=</span> <span class="n">chem_mono</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ChemId&#39;</span><span class="p">]</span>
                <span class="n">metsim_url</span> <span class="o">=</span> <span class="n">metsim_url_base</span><span class="o">+</span><span class="n">guid</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">chem_Id</span>
                <span class="n">oecd_metab_list</span> <span class="o">=</span> <span class="n">metsim_exec</span><span class="p">(</span><span class="n">metsim_url</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oecd_metab_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                            <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                            <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">oecd_metab_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                                           <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                           <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                           <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                           <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                           <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                                          <span class="p">},</span>
                                                           <span class="p">}</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oecd_metab_list</span><span class="p">))]</span>
                                          <span class="p">})</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Metsim succeeded for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">chem_mono</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Metsim failed. Attempting metsim from alternate monoconstituent ChemIds for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
                <span class="c1">#If first chemID yields no metabolites, and there are other monoconstituent </span>
                <span class="c1">#Chem_Ids to try run them until a non-empty metabolite list is yielded</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_mono</span><span class="p">)):</span>
                    <span class="n">oecd_metab_list</span> <span class="o">=</span> <span class="n">metsim_exec</span><span class="p">(</span><span class="n">metsim_url_base</span><span class="o">+</span><span class="n">guid</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">chem_mono</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;ChemId&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oecd_metab_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span>
                                                    <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                    <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                    <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">oecd_metab_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                                                   <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                                                  <span class="p">},</span>
                                                                   <span class="p">}</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oecd_metab_list</span><span class="p">))]</span>
                                                  <span class="p">})</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Metsim succeeded for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#No available ChemIDs yield a metabolite list, inspect list manually later.</span>
                        <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span>
                                                <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                                                <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                               <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                               <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                               <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                               <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                               <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                                              <span class="p">}</span>
                                                              <span class="p">}]</span>
                                              <span class="p">}]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Metsim failed for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;. Alternate ChemId &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_mono</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; yielded no metabolites.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span>
                                        <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                                        <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                        <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                       <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                       <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                       <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                       <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                       <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                                      <span class="p">}</span>
                                                      <span class="p">}]</span>
                                      <span class="p">}]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Metsim failed for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;. No alternate ChemIds found.&#39;</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="n">oecd_dict</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span>
                                    <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                                    <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                    <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                   <span class="s1">&#39;inchikey&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                   <span class="s1">&#39;casrn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                   <span class="s1">&#39;hcd_smiles&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                   <span class="s1">&#39;dtxsid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                                   <span class="s1">&#39;chem_name&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                                                  <span class="p">}</span>
                                                  <span class="p">}]</span>
                                  <span class="p">}]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;metsim failed for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;. Neither SMILES nor CASRN yield valid ChemIds.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">oecd_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="metsim.sim.metsim_tb.metsim_tb_search_logkow" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">metsim_tb_search_logkow</span><span class="p">(</span><span class="n">casrn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tb_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Search the OECD Toolbox database via its WebAPI for a chemical ID for an input chemical, and then 
return the octanol-water partition coefficient to have a measure of its hydrophobicity.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>casrn</code></b>
              –
              <div class="doc-md-description">
                <p>CAS Registry Number</p>
              </div>
            </li>
            <li>
              <b><code>tb_port</code></b>
              –
              <div class="doc-md-description">
                <p>Port number selected for locally running instance of the Toolbox Server</p>
              </div>
            </li>
            <li>
              <b><code>host_name</code></b>
              –
              <div class="doc-md-description">
                <p>ip address for the server runnning the Toolbox</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>log_kow</code></b>              –
              <div class="doc-md-description">
                <p>Log10 scaled octanol-water partition coefficient, if available.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>metsim/sim/metsim_tb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">metsim_tb_search_logkow</span><span class="p">(</span><span class="n">casrn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">host_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tb_port</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Search the OECD Toolbox database via its WebAPI for a chemical ID for an input chemical, and then </span>
<span class="sd">    return the octanol-water partition coefficient to have a measure of its hydrophobicity.</span>

<span class="sd">    Args: </span>
<span class="sd">        casrn: CAS Registry Number</span>
<span class="sd">        tb_port: Port number selected for locally running instance of the Toolbox Server</span>
<span class="sd">        host_name: ip address for the server runnning the Toolbox</span>

<span class="sd">    Returns:</span>
<span class="sd">        log_kow: Log10 scaled octanol-water partition coefficient, if available.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">search_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;http://</span><span class="si">{</span><span class="n">host_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tb_port</span><span class="si">}</span><span class="s2">/api/v6/search/&quot;&quot;&quot;</span>
    <span class="n">kow_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;http://</span><span class="si">{</span><span class="n">host_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tb_port</span><span class="si">}</span><span class="s2">/api/v6/calculation/41552380-4d5d-4eab-bee0-03774c0eabb6/&quot;&quot;&quot;</span>
    <span class="n">search_cas</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">casrn</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">search_base</span><span class="o">+</span><span class="s1">&#39;cas/&#39;</span><span class="o">+</span><span class="n">casrn</span><span class="o">+</span><span class="s1">&#39;/true&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">kow_exec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">chem_Id</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">kow_url</span><span class="o">+</span><span class="n">chem_Id</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">stereo_filter</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;@&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">]</span>
    <span class="n">chem_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">casrn</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No CASRN provided.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;NOCAS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">casrn</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searching Toolbox database for ChemIds using CASRN: &#39;</span><span class="o">+</span><span class="n">casrn</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">cas_nohyphen</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">casrn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
            <span class="n">chem_entries</span> <span class="o">=</span> <span class="n">search_cas</span><span class="p">(</span><span class="n">cas_nohyphen</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid CASRN (contains &quot;NOCAS&quot;). Cannot search for ChemIds using this identifier.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad http request for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; CASRN&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Toolbox database ChemIds found for CASRN: &#39;</span><span class="o">+</span><span class="n">casrn</span><span class="o">+</span><span class="s1">&#39; via Toolbox API search.&#39;</span><span class="p">)</span>
        <span class="c1">#remove chem name lists from dicts so that duplicate dicts can be removed via set comprehension</span>
        <span class="n">rem_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">chem_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Names&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">))]</span>
        <span class="n">chem_entries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">))}]</span> <span class="c1">#remove duplicate entries</span>
        <span class="c1">#Filter out mixtures, and substances with no casrn:</span>
        <span class="n">chem_mono</span> <span class="o">=</span> <span class="p">[</span><span class="n">chem_entries</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_entries</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">chem_entries</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;SubstanceType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MonoConstituent&#39;</span> <span class="ow">and</span> <span class="n">chem_entries</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;Cas&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="c1">#Store ChemID so long as smiles has no stereo information:</span>
        <span class="n">chem_Id</span> <span class="o">=</span> <span class="p">[</span><span class="n">chem_mono</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;ChemId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_mono</span><span class="p">))</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">stereo_filter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">chem_mono</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;Smiles&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stereo_filter</span><span class="p">))])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chem_Id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Monoconstituent ChemIds found within search results...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_Id</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating Log Kow value for ChemId &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chem_Id</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">log_kow</span> <span class="o">=</span> <span class="n">kow_exec</span><span class="p">(</span><span class="n">chem_Id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">log_kow</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">log_kow</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Log Kow value successfully determined for CASRN: &#39;</span><span class="o">+</span><span class="n">casrn</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_kow</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Log Kow value not found for current ChemId.&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad http request for index #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; Log Kow.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">log_kow</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">log_kow</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ChemId(s) found, but no Log Kow available for CASRN: &#39;</span><span class="o">+</span><span class="n">casrn</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ChemId(s) found, but no Log Kow available for CASRN: &#39;</span><span class="o">+</span><span class="n">casrn</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No ChemId(s) found for CASRN: &#39;</span><span class="o">+</span><span class="n">casrn</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="metsim.sim.metsim_times"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="metsim.sim.metsim_times.metsim_run_times" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">metsim_run_times</span><span class="p">(</span><span class="n">times_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;vitro&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Takes the metabolism report loaded as a pandas dataframe from the CSV output from the TIMES Desktop Application for a given simulator and returns the metsim hierarchy
with all available metadata from EPA Cheminformatics Modules API for all precursor-successor relationships predicted from either the In Vivo Rat Simulator 
or the In Vitro Rat Liver S9 model within times. </p>
<p>How to get the CSV required:
In the tab named after the simulator in the TIMES GUI, generate the metabolism "Map" from the "Reports" toolbar after running the simulator on all parent chemicals,
The "Map Report" table that is produced can be copied to the clipboard, pasted into spreadsheet software, and saved as a CSV file. Load this as a dataframe via Pandas.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>times_df</code></b>
                  (<code>(dataframe, required)</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Dataframe of metabolism output from TIMES</p>
              </div>
            </li>
            <li>
              <b><code>model</code></b>
                  (<code>str</code>, default:
                      <code>&#39;vitro&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Specify either In Vitro Rat Liver S9 with "vitro" (default), or In Vivo Rat Simulator with "vivo".</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>times_metsim_dict</code></b>(                  <code>list of dict</code>
)              –
              <div class="doc-md-description">
                <p>Generationally tracked, MetSim hierarchy structured dictionary of precursor-successor relationships for all available input chemicals</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>metsim/sim/metsim_times.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">metsim_run_times</span><span class="p">(</span><span class="n">times_df</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;vitro&#39;</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes the metabolism report loaded as a pandas dataframe from the CSV output from the TIMES Desktop Application for a given simulator and returns the metsim hierarchy</span>
<span class="sd">    with all available metadata from EPA Cheminformatics Modules API for all precursor-successor relationships predicted from either the In Vivo Rat Simulator </span>
<span class="sd">    or the In Vitro Rat Liver S9 model within times. </span>

<span class="sd">    How to get the CSV required:</span>
<span class="sd">    In the tab named after the simulator in the TIMES GUI, generate the metabolism &quot;Map&quot; from the &quot;Reports&quot; toolbar after running the simulator on all parent chemicals,</span>
<span class="sd">    The &quot;Map Report&quot; table that is produced can be copied to the clipboard, pasted into spreadsheet software, and saved as a CSV file. Load this as a dataframe via Pandas.</span>

<span class="sd">    Args:</span>
<span class="sd">        times_df (dataframe, required): Dataframe of metabolism output from TIMES</span>
<span class="sd">        model (str, optional): Specify either In Vitro Rat Liver S9 with &quot;vitro&quot; (default), or In Vivo Rat Simulator with &quot;vivo&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        times_metsim_dict (list of dict): Generationally tracked, MetSim hierarchy structured dictionary of precursor-successor relationships for all available input chemicals </span>
<span class="sd">    &quot;&quot;&quot;</span>




    <span class="k">if</span> <span class="n">times_df</span><span class="o">.</span><span class="n">empty</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">precursor_df</span> <span class="o">=</span> <span class="n">times_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">times_df</span><span class="p">[</span><span class="s1">&#39;Chemical name&#39;</span><span class="p">]),:]</span>
        <span class="n">precursor_df</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Chemical name&#39;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">successor_df</span> <span class="o">=</span> <span class="n">times_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">times_df</span><span class="p">[</span><span class="s1">&#39;Chemical name&#39;</span><span class="p">]),:]</span>
        <span class="c1">#print(successor_df)</span>
        <span class="n">times_metsim_dict</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">times_cache</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;vivo&#39;</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;In Vivo Rat Simulator v08.14&#39;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;vitro&#39;</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;In Vitro Rat Liver S9 v12.18&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">precursor_df</span><span class="p">)):</span>
            <span class="c1"># print(&#39;i = &#39;,i)</span>
            <span class="k">if</span> <span class="n">precursor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;SMILES&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cache_item</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cache_item</span> <span class="ow">in</span> <span class="n">times_cache</span><span class="p">]:</span>
                <span class="n">times_metsim_dict</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%Hh%Mm%Ss&#39;</span><span class="p">)),</span>
                                          <span class="s1">&#39;software&#39;</span><span class="p">:</span> <span class="s1">&#39;OASIS TIMES&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;2.31.2.82&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;params&#39;</span><span class="p">:{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                                    <span class="s1">&#39;organism&#39;</span><span class="p">:</span> <span class="s1">&#39;Rat&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;site_of_metabolism&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>
                                                   <span class="p">},</span>
                                          <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">metsim_hcd_out</span><span class="p">(</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;SMILES&#39;</span><span class="p">],</span> <span class="n">dtxsid</span> <span class="o">=</span> <span class="n">precursor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;Chemical name&#39;</span><span class="p">]),</span>
                                          <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">[]</span>
                                        <span class="p">})</span>
                <span class="n">times_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times_metsim_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input query added to metadata cache...&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input SMILES found in cached results. Inserting into dictionary...&#39;</span><span class="p">)</span>
                <span class="n">times_metsim_dict</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%Hh%Mm%Ss&#39;</span><span class="p">)),</span>
                                          <span class="s1">&#39;software&#39;</span><span class="p">:</span> <span class="s1">&#39;OASIS TIMES&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;2.31.2.82&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;params&#39;</span><span class="p">:{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                                    <span class="s1">&#39;organism&#39;</span><span class="p">:</span> <span class="s1">&#39;Rat&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;site_of_metabolism&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>
                                                   <span class="p">},</span>
                                          <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">times_cache</span><span class="p">[[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times_cache</span><span class="p">))</span> <span class="k">if</span> <span class="n">times_cache</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">precursor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;SMILES&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]],</span>
                                          <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">[]</span>
                                        <span class="p">})</span>
            <span class="n">tmpdf</span> <span class="o">=</span> <span class="n">successor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">successor_df</span><span class="p">[</span><span class="s1">&#39;Parent Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">precursor_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">precursor_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;Parent Number&#39;</span><span class="p">],:]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())):</span>
                <span class="c1"># print(&#39;j = &#39;,j)</span>
                <span class="n">times_metsim_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;precursor&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
                                                       <span class="s1">&#39;successors&#39;</span><span class="p">:</span> <span class="p">[]</span>
                                                     <span class="p">})</span>
                <span class="k">for</span> <span class="n">k</span>  <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="p">:])):</span>
                    <span class="c1"># print(&#39;k = &#39;,k)</span>
                    <span class="n">k_idx</span> <span class="o">=</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">index</span>
                    <span class="k">if</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;ID of metabolite&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]),</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cache_item</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cache_item</span> <span class="ow">in</span> <span class="n">times_cache</span><span class="p">]:</span>
                            <span class="n">times_metsim_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;precursor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metsim_hcd_out</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;ID of metabolite&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]),</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">times_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times_metsim_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;precursor&#39;</span><span class="p">])</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;precursor metabolite query added to metadata cache...&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precursor SMILES found in cached results. Inserting into dictionary...&#39;</span><span class="p">)</span>
                            <span class="n">times_metsim_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;precursor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">times_cache</span><span class="p">[[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times_cache</span><span class="p">))</span> <span class="k">if</span> <span class="n">times_cache</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;ID of metabolite&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]),</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]]</span>

                        <span class="k">if</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cache_item</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cache_item</span> <span class="ow">in</span> <span class="n">times_cache</span><span class="p">]:</span>
                            <span class="n">times_metsim_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;successors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Transformation type&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Transformation name&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="n">metsim_hcd_out</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]),</span>
                                                                                    <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Level of generation&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                                                                                   <span class="p">})</span>
                            <span class="n">times_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times_metsim_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;successors&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;metabolite&#39;</span><span class="p">])</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;successor metabolite query added to metadata cache...&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successor SMILES found in cached results. Inserting into dictionary...&#39;</span><span class="p">)</span>
                            <span class="n">times_metsim_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;successors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Transformation type&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Transformation name&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="n">times_cache</span><span class="p">[[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times_cache</span><span class="p">))</span> <span class="k">if</span> <span class="n">times_cache</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]][</span><span class="mi">0</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Level of generation&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                                                                                   <span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">times_metsim_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;precursor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">times_metsim_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cache_item</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cache_item</span> <span class="ow">in</span> <span class="n">times_cache</span><span class="p">]:</span>
                            <span class="n">times_metsim_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;successors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Transformation type&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Transformation name&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="n">metsim_hcd_out</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]),</span>
                                                                                    <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Level of generation&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                                                                                   <span class="p">})</span>
                            <span class="n">times_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times_metsim_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;successors&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;metabolite&#39;</span><span class="p">])</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;successor metabolite query added to metadata cache...&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successor SMILES found in cached results. Inserting into dictionary...&#39;</span><span class="p">)</span>
                            <span class="n">times_metsim_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;successors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;enzyme&#39;</span><span class="p">:</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Transformation type&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;mechanism&#39;</span><span class="p">:</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Transformation name&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;metabolite&#39;</span><span class="p">:</span> <span class="n">times_cache</span><span class="p">[[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times_cache</span><span class="p">))</span> <span class="k">if</span> <span class="n">times_cache</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]][</span><span class="mi">0</span><span class="p">]],</span>
                                                                                    <span class="s1">&#39;generation&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="p">[</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmpdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmpdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="s1">&#39;Predecessor ID&#39;</span><span class="p">],</span> <span class="s1">&#39;Level of generation&#39;</span><span class="p">][</span><span class="n">k_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                                                                                   <span class="p">})</span>
    <span class="k">return</span> <span class="n">times_metsim_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../utl/" class="btn btn-neutral float-right" title="Utilities">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../utl/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
